<div class="perfil-container">
  <div *ngIf="loading" class="loading-state">
    <div class="spinner"></div>
    <p>Cargando tu perfil...</p>
  </div>

  <div *ngIf="error && !loading" class="error-state">
    <app-icon name="XMark" class="error-icon"></app-icon>
    <h3>{{ error }}</h3>
    <button (click)="cargarPerfilAutomatico()" class="btn-reintentar">Reintentar</button>
  </div>

  <div *ngIf="perfil && !loading" class="perfil-content">
    <div class="perfil-header">
      <h1>{{ editando ? 'Editando Mi Perfil' : 'Mi Perfil' }}</h1>

      <div class="acciones">
        <button *ngIf="!editando" (click)="toggleEdicion()" class="btn-editar">
          <app-icon name="Pencil"></app-icon>
          Editar Perfil
        </button>

        <div *ngIf="editando" class="btn-group">
          <button (click)="cancelarEdicion()" class="btn-cancelar" [disabled]="guardando">
            Cancelar
          </button>
          <button (click)="guardarCambios()" class="btn-guardar" [disabled]="guardando">
            {{ guardando ? 'Guardando...' : 'Guardar Cambios' }}
          </button>
        </div>
      </div>
    </div>

    <div class="perfil-layout">
      <aside class="perfil-sidebar">
        <div class="foto-perfil">
          <img
            [src]="perfil?.url_foto_perfil || 'assets/avatar-default.png'"
            alt="Foto de perfil"
            class="imagen-circular"
          />

          <div *ngIf="editando" class="overlay-camara">
            <button (click)="fileInput.click()" class="btn-cambiar-foto">
              <app-icon name="Camera"></app-icon>
            </button>
            <input
              #fileInput
              type="file"
              (change)="onFileSelected($event)"
              accept="image/*"
              style="display: none"
            />
          </div>
        </div>

        <div class="info-section">
          <h2 *ngIf="!editando">{{ nombreCompleto }}</h2>

          <div *ngIf="editando" class="form-group">
            <label>Nombre</label>
            <input
              type="text"
              [(ngModel)]="perfil.nombre"
              placeholder="Tu nombre"
              class="input-field"
            />
          </div>

          <div *ngIf="editando" class="form-group">
            <label>Apellido</label>
            <input
              type="text"
              [(ngModel)]="perfil.apellido"
              placeholder="Tu apellido"
              class="input-field"
            />
          </div>
        </div>

        <div class="info-section">
          <h3 *ngIf="!editando && perfil.titulo_cv">{{ perfil.titulo_cv }}</h3>
          <p *ngIf="!editando && !perfil.titulo_cv" class="texto-vacio">
            Aún no has agregado un título profesional
          </p>

          <div *ngIf="editando" class="form-group">
            <label>Título Profesional</label>
            <input
              type="text"
              [(ngModel)]="perfil.titulo_cv"
              placeholder="Ej: Desarrollador Full Stack"
              class="input-field"
            />
          </div>
        </div>

        <div class="info-section">
          <div class="contacto-item">
            <app-icon name="Mail"></app-icon>
            <span>{{ perfil.email }}</span>
          </div>

          <div class="contacto-item" *ngIf="!editando && perfil.telefono">
            <app-icon name="Phone"></app-icon>
            <span>{{ perfil.telefono }}</span>
          </div>

          <div *ngIf="editando" class="form-group">
            <label>Teléfono</label>
            <input
              type="tel"
              [(ngModel)]="perfil.telefono"
              placeholder="+52 123 456 7890"
              class="input-field"
            />
          </div>

          <div class="contacto-item" *ngIf="!editando && perfil.ubicacion">
            <app-icon name="MapPin"></app-icon>
            <span>{{ perfil.ubicacion }}</span>
          </div>

          <div *ngIf="editando" class="form-group">
            <label>Ubicación</label>
            <input
              type="text"
              [(ngModel)]="perfil.ubicacion"
              placeholder="Ciudad, Estado"
              class="input-field"
            />
          </div>
        </div>

        <div class="info-section" *ngIf="editando">
          <label class="checkbox-label">
            <input type="checkbox" [(ngModel)]="perfil.disponibilidad_viajar" />
            Disponible para viajar
          </label>

          <label class="checkbox-label">
            <input type="checkbox" [(ngModel)]="perfil.disponibilidad_residencia" />
            Disponible para cambio de residencia
          </label>
        </div>
      </aside>

      <main class="perfil-main">
        <section class="seccion-cv">
          <h3>
            <app-icon name="User"></app-icon>
            Sobre Mí
          </h3>

          <p *ngIf="!editando && perfil.descripcion" class="descripcion">
            {{ perfil.descripcion }}
          </p>

          <p *ngIf="!editando && !perfil.descripcion" class="texto-vacio">
            Cuéntanos sobre ti, tus intereses y objetivos profesionales
          </p>

          <div *ngIf="editando" class="form-group">
            <textarea
              [(ngModel)]="perfil.descripcion"
              placeholder="Cuéntanos sobre ti..."
              rows="5"
              class="textarea-field"
            ></textarea>
          </div>
        </section>

        <section class="seccion-cv">
          <div class="seccion-header">
            <h3>
              <app-icon name="AcademicCap"></app-icon>
              Educación
            </h3>
            <button *ngIf="editando" (click)="agregarItem('estudios')" class="btn-agregar-mini">
              + Agregar
            </button>
          </div>

          <div *ngIf="perfil.estudios.length === 0" class="texto-vacio">
            Aún no has agregado estudios
          </div>

          <div class="timeline">
            <div *ngFor="let estudio of perfil.estudios; let i = index" class="timeline-item">
              <ng-container *ngIf="!editando">
                <div class="timeline-marker"></div>
                <div class="timeline-content">
                  <h4>{{ estudio.carrera }}</h4>
                  <p class="institucion">{{ estudio.centro_estudio }}</p>
                  <p class="nivel">{{ estudio.nivel_estudio }}</p>
                  <p class="fechas">
                    {{ estudio.fecha_inicio | date : 'MMM yyyy' }} -
                    {{ estudio.en_curso ? 'Presente' : (estudio.fecha_fin | date : 'MMM yyyy') }}
                  </p>
                </div>
              </ng-container>

              <ng-container *ngIf="editando">
                <div class="form-card">
                  <button (click)="eliminarItem(perfil.estudios, i)" class="btn-eliminar-item">
                    <app-icon name="Trash"></app-icon>
                  </button>

                  <div class="form-group">
                    <label>Carrera</label>
                    <input type="text" [(ngModel)]="estudio.carrera" class="input-field" />
                  </div>
                </div>
              </ng-container>
            </div>
          </div>
        </section>

        <section class="seccion-cv">
          <div class="seccion-header">
            <h3>
              <app-icon name="Briefcase"></app-icon>
              Experiencia Laboral
            </h3>
            <button *ngIf="editando" (click)="agregarItem('experiencias')" class="btn-agregar-mini">
              + Agregar
            </button>
          </div>

          <div *ngIf="perfil.experiencias.length === 0" class="texto-vacio">
            Aún no has agregado experiencia laboral
          </div>

          <div class="timeline">
            <div *ngFor="let exp of perfil.experiencias; let i = index" class="timeline-item">
              <ng-container *ngIf="!editando">
                <div class="timeline-marker"></div>
                <div class="timeline-content">
                  <h4>{{ exp.titulo_puesto }}</h4>
                  <p class="institucion">{{ exp.nombre_empresa }}</p>
                  <p class="descripcion">{{ exp.descripcion_tareas }}</p>
                  <p class="fechas">
                    {{ exp.fecha_inicio | date : 'MMM yyyy' }} -
                    {{
                      exp.actualmente_trabajando ? 'Presente' : (exp.fecha_fin | date : 'MMM yyyy')
                    }}
                  </p>
                </div>
              </ng-container>

              <ng-container *ngIf="editando">
                <div class="form-card">
                  <button (click)="eliminarItem(perfil.experiencias, i)" class="btn-eliminar-item">
                    <app-icon name="Trash"></app-icon>
                  </button>
                  <div class="form-group">
                    <label>Puesto</label>
                    <input type="text" [(ngModel)]="exp.titulo_puesto" class="input-field" />
                  </div>
                </div>
              </ng-container>
            </div>
          </div>
        </section>

        <section class="seccion-cv">
          <div class="seccion-header">
            <h3>
              <app-icon name="Code"></app-icon>
              Proyectos
            </h3>
            <button *ngIf="editando" (click)="agregarItem('proyectos')" class="btn-agregar-mini">
              + Agregar
            </button>
          </div>

          <div *ngIf="perfil.proyectos.length === 0" class="texto-vacio">
            Aún no has agregado proyectos
          </div>

          <div class="proyectos-grid">
            <div *ngFor="let proy of perfil.proyectos; let i = index" class="proyecto-card">
              <ng-container *ngIf="!editando">
                <h4>{{ proy.nombre_proyecto }}</h4>
                <p class="descripcion">{{ proy.descripcion }}</p>
                <p class="tecnologias">{{ proy.tecnologias }}</p>
                <a
                  *ngIf="proy.url_proyecto"
                  [href]="proy.url_proyecto"
                  target="_blank"
                  class="link-proyecto"
                >
                  Ver proyecto <app-icon name="ExternalLink"></app-icon>
                </a>
              </ng-container>

              <ng-container *ngIf="editando">
                <div class="form-card">
                  <button (click)="eliminarItem(perfil.proyectos, i)" class="btn-eliminar-item">
                    <app-icon name="Trash"></app-icon>
                  </button>
                  <div class="form-group">
                    <label>Nombre Proyecto</label>
                    <input type="text" [(ngModel)]="proy.nombre_proyecto" class="input-field" />
                  </div>
                </div>
              </ng-container>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>
</div>
